from typing import Iterator

from chat.chat_util import stream_openai
from chat.conversation import Conversation, AiChatMessage, Message, present_results
from chat.tools.tool import Tool
from nlp.agent import Agent


class AskAnExpert(Tool):
    schema = {
        "name": "ask_an_expert",
        "description": "If none of the other tools satisfy the user's request, ask an expert for help."
    }
    verbal_return_type = "an answer generated by GPT-4o"

    def call(self, agent: Agent, history=Conversation([]), request: str = None, state=None) -> Iterator[Message]:
        """
        Asks the LLM to answer the user's prompt directly.
        """
        yield present_results(agent, history, self.verbal_return_type)
        yield _ask_llm_for_expert_opinion(agent, history, request)


def _ask_llm_for_expert_opinion(agent: Agent, conversation: Conversation, request: str):
    """
    Asks the LLM to answer the user's prompt directly.
    """
    response = agent.openai.chat.completions.create(
        model="gpt-4o",
        temperature=1,
        stream=True,
        messages=conversation.render_to_openai(
            system_message="You are a biodiversity expert. You write in the style of an encyclopedia.", request=request)
    )

    return AiChatMessage(stream_openai(response))
